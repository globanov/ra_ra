<!-- templates/minimal.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Raft RAG</title>
    <meta charset="utf-8">
    <style>
        body { font-family: monospace; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        h2 { margin: 0 0 10px 0; }
        input, textarea, button { width: 100%; padding: 8px; margin: 5px 0; }
        button { background: black; color: white; border: none; cursor: pointer; }
        button:hover { opacity: 0.8; }
        .file-info { font-size: 12px; color: #666; margin: 5px 0; }
        .answer { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .source { font-size: 12px; color: #444; margin: 3px 0; padding-left: 10px; }
        .success { color: green; }
        .error { color: red; }
        .flex { display: flex; gap: 10px; }
        .flex > * { flex: 1; }
    </style>
</head>
<body>
<div class="container">
    <h1>Raft RAG</h1>

    <!-- 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
    <div class="section">
        <h2>üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h2>
        <div class="flex">
            <input type="file" id="fileInput" accept=".pdf,.txt">
            <button onclick="uploadFile()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button onclick="clearDoc()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="fileStatus" class="file-info"></div>
    </div>

    <!-- 2. –°—Ç–∞—Ç—É—Å -->
    <div class="section">
        <h2>üìä –°—Ç–∞—Ç—É—Å</h2>
        <div id="status">‚ùå –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
        <button onclick="loadStatus()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </div>

    <!-- 3. –í–æ–ø—Ä–æ—Å -->
    <div class="section">
        <h2>üí≠ –í–æ–ø—Ä–æ—Å –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É</h2>
        <textarea id="question" rows="3" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>
        <button onclick="askQuestion()">–°–ø—Ä–æ—Å–∏—Ç—å</button>
        <div id="answer" class="answer"></div>
    </div>

    <!-- 4. API —Å—Å—ã–ª–∫–∏ -->
    <div class="section">
        <h2>üîó API</h2>
        <div>
            <a href="/docs" target="_blank">Swagger UI</a> |
            <a href="/" target="_blank">JSON API</a>
        </div>
    </div>
</div>

<script>
    const API = window.location.origin;

    async function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');

        const form = new FormData();
        form.append('file', file);

        try {
            const res = await fetch(API + '/upload', { method: 'POST', body: form });
            const data = await res.json();

            if (res.ok) {
                showMessage(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω: ${data.document_name} (${data.chunks_count} —á–∞—Å—Ç–µ–π)`, 'success');
                loadStatus();
            } else {
                showMessage(`‚ùå –û—à–∏–±–∫–∞: ${data.detail}`, 'error');
            }
        } catch(e) {
            showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`, 'error');
        }
    }

    async function loadStatus() {
        const res = await fetch(API + '/stats');
        const data = await res.json();

        if (data.document_loaded) {
            document.getElementById('status').innerHTML =
                `‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: ${data.chunks_count} —á–∞—Å—Ç–µ–π`;
        } else {
            document.getElementById('status').innerHTML =
                '‚ùå –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞';
        }
    }

    async function askQuestion() {
        const question = document.getElementById('question').value.trim();
        if (!question) return alert('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');

        const answerDiv = document.getElementById('answer');
        answerDiv.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';

        try {
            const res = await fetch(API + '/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, top_k: 2 })
            });

            const data = await res.json();

            if (res.ok) {
                let html = `<strong>–û—Ç–≤–µ—Ç:</strong><br>${data.answer}<br><br>`;

                if (data.sources && data.sources.length > 0) {
                    html += `<strong>–ò—Å—Ç–æ—á–Ω–∏–∫–∏:</strong>`;
                    data.sources.forEach((s, i) => {
                        html += `<div class="source">${i+1}. ${s.substring(0, 150)}... (—Å—Ö–æ–¥—Å—Ç–≤–æ: ${data.similarities[i]})</div>`;
                    });
                }

                answerDiv.innerHTML = html;
            } else {
                answerDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${data.detail}`;
            }
        } catch(e) {
            answerDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${e.message}`;
        }
    }

    function clearDoc() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç?')) {
            // –¢—Ä–µ–±—É–µ—Ç—Å—è endpoint /clear –≤ API
            showMessage('‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç endpoint /clear', 'error');
        }
    }

    function showMessage(text, type) {
        const div = document.getElementById('fileStatus');
        div.innerHTML = `<span class="${type}">${text}</span>`;
        setTimeout(() => div.innerHTML = '', 5000);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadStatus();
</script>
</body>
</html>